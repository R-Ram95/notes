# Load Balancers

Elastic Load Balancer (ELB) is a managed load balancer that distributes traffic to a set of resources such as EC2 instances, containers, IP addresses, and Lambda functions. They are essentially servers that forward traffic to multiple servers downstream.

- AWS guarantees it will be working
- AWS takes care of upgrades, maintenance, high availability
- provides only a few configuration knobs

![[/Untitled 61.png|Untitled 61.png]]

  

**Load Balancer Security:**

![[/Untitled 1 42.png|Untitled 1 42.png]]

- Load balancer accepts requests from anywhere
- EC2 should only accept requests from Load Balancer

**ELB Features:**

**Hybrid -** ELB can balance IP addresses, i.e. it can balance on-prem servers

**High Availability** - make sure ELB targets are across multiple AZs

**Scalability** - ELB automatically scales to meet demand of incoming traffic

**Health Checks**:

ELB supports two types of health checks:

1) establish a connection to EC2 using TCP and marking instance as available

2) Make HTTP or HTTPS request to webpage

**ELB Components**

ELB is made up of three components

Rule: associate target group to listeners. Rules are made up of two conditions 1) IP address of client and 2) which target group to send traffic to

Listeners on the client side

Target Group server side

  

**Target Groups**

  

![[/Untitled 2 33.png|Untitled 2 33.png]]

- EC2 instance (can be managed by Auto Scaling Groups) - HTTP
- ECS tasks - HTTP
- Lambda functions - HTTP request is translated into JSON event
- IP addresses - must be private
- health checks done at target group level
- fixed hostname
- application servers access client ips via the request header

# Types

## Classic Load Balancer (CLB)

- supports TCP (layer 4), HTTP & HTTPS (Layer 7)
- health checks are TCP or HTTP
- fixed hostname

## Application Load Balancer (ALB)

ALBs are ideal for balancing HTTP and HTTPS traffic based on request data.

- HTTP only (layer 7)
- supports gRPC
- supprt HTTP/2 and websockets
- redirects from HTTP to HTTPS
- load balancing to multiple target groups (HTTP applications across machines)
- could route to different applications based on:
    - URL e.g. on [`example.com/users`](http://example.com/users) and `example.com/posts`
    - hostname e.g. `[one.example.com](http://one.example.com)` and other.example.com
    - query String, headers e.g. `example.com/users?id=123&order=false`
- ALB is good for micro services and container based applications
- has port mapping feature ⇒ redirects to dynamic port in ECS

![[/Untitled 3 32.png|Untitled 3 32.png]]

  

## Network Load Balancer (NLB)

NLB is ideal for balancing TCP and UDP traffic based on IP protocol data.

- works in layer 4 (TCP & UDP)
- millions of requests per second
- ~100ms latency vs 400ms (ALB)
- one static IP per AZ
- **NLB = extreme performance, TCP or UDP**
- Target groups:
    - EC2 Instance
    - Ip addresses - private
    - ALB
- health checks support TCP, HTTP, HTTPS

![[/Untitled 4 22.png|Untitled 4 22.png]]

## Gateway Load Balancer (ALB)

- analyze network traffic using 3rd party appliances
- operates at Layer 3 (Network Layer) - IP packets
- combines two functions:
    - Transparent Network Gateway - single entry/exit for all traffic
    - Load Balancer - distributes traffic to virtual appliances
- **uses GENEVE protocol on port 6081**
- Target Groups:
    
    - EC2
    - Ip address - private
    
    ![[/Untitled 5 16.png|Untitled 5 16.png]]
    

# Sticky Sessions

- implement stickiness so that same client is redirected to the same instance
- works for CLB and ALB
- uses cookie that has expiration date
- Use Case: makes sure that user doesn’t lose session data
- may cause imbalance over backend EC2 instance

# Cross-Zone Load Balancing

## Cookie Names

- Application-based cookies:
    - custom cookie
        - generated by target
        - name specified individually for each target group
    - application cookie
        - generated by load balancer
        - name is: AWSALBAPPP
- Duration-based cookies:
    - generated by load balancer
    - name is AWSALB for ALB, AWSELB for CLB

  

# SSL Certificates

- Load Balancer needs SSL certificates issues but a Certificate Authority (CA) to prove their identity to clients
- Load Balancers can redirect traffic to multiple domains ⇒ how do we load multiple certificates for multiple domains?
- Using Server Name Identification (SNI)
    
    ![[/Untitled 6 13.png|Untitled 6 13.png]]
    
    - client requests to specific domain
    - LB can send the correct cert relevant to the requested domain
    - SNI is only available to ALB and NLB ⇒ CLB requires a separate CLB for each domain

# Session Draining

![[/Untitled 7 9.png|Untitled 7 9.png]]

Concept is called:

Connection Draining - CLB

Deregistration Delay - ALB & NLB

- while EC2 is shutting down, requests for existing clients are completed before turning the connection off
- ELB will stop sending new requests to the EC2
- this time period is able to be set between 1 - 3600 seconds
- good idea to set time to a small period if requests are short

# Selecting between ELB types

![[/Untitled 8 8.png|Untitled 8 8.png]]
